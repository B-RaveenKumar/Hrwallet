{% extends 'admin_panel/base.html' %}

{% block title %}User Management - HR Wallet{% endblock %}

{% block extra_css %}
<style>
    .user-card {
        transition: all 0.3s ease;
        border: 1px solid #e2e8f0;
    }

    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .role-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .search-box {
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
    }

    .search-box:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-create {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        color: white;
    }

    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .form-control {
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .loading-spinner {
        display: none;
    }

    .alert-floating {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        border-radius: 10px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-users me-2 text-primary"></i>
                        User Management
                    </h2>
                    <p class="text-muted mb-0">Manage users and their access permissions</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" id="exportUsersBtn">
                        <i class="fas fa-file-export me-2"></i>
                        Export CSV
                    </button>
                    <button class="btn btn-create" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="fas fa-plus me-2"></i>
                        Create New User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="position-relative">
                <i class="fas fa-search position-absolute" style="left: 1.5rem; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
                <input type="text" class="form-control search-box ps-5" id="userSearch" placeholder="Search by name, email, username, or ID...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="roleFilter" style="border-radius: 10px; padding: 0.75rem;">
                <option value="">All Roles</option>
                <option value="super_admin">Super Admin</option>
                <option value="hr_manager">HR Manager</option>
                <option value="employee">Employee</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="statusFilter" style="border-radius: 10px; padding: 0.75rem;">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="deptFilter" style="border-radius: 10px; padding: 0.75rem;">
                <option value="">All Departments</option>
            </select>
        </div>
    </div>

    <!-- Users Grid -->
    <div class="row" id="usersGrid">
        <div class="col-12 text-center py-5">
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading users...</p>
            </div>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2 text-primary"></i>
                    Create New User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" name="last_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" name="username" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role *</label>
                            <select class="form-select" name="role" required>
                                <option value="">Select Role</option>
                                <option value="employee">Employee</option>
                                <option value="hr_manager">HR Manager</option>
                                <option value="super_admin">Super Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                    </div>
                    <div class="row" id="employeeFields" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Employee ID</label>
                            <input type="text" class="form-control" name="employee_id" placeholder="Auto-generated if empty">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Job Title</label>
                            <input type="text" class="form-control" name="job_title" placeholder="e.g., Software Developer">
                        </div>
                    </div>
                    <div class="row" id="employeeFields2" style="display: none;">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="phone" placeholder="+1-555-0123">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department_id">
                                <option value="">Select Department</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-create" id="createUserBtn">
                    <span class="btn-text">
                        <i class="fas fa-plus me-2"></i>
                        Create User
                    </span>
                    <span class="btn-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Creating...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Alert Container -->
<div id="alertContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize user management (expose globally for onclick handlers)
    window.userManagement = new UserManagement();
    window.userManagement.init();
});

class UserManagement {
    constructor() {
        this.users = [];
        this.filteredUsers = [];
        this.searchTimeout = null;
    }

    init() {
        this.bindEvents();
        this.loadDepartments();
        this.loadUsers();
    }

    bindEvents() {
        // Search functionality
        document.getElementById('userSearch').addEventListener('input', () => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.loadUsers();
            }, 300);
        });

        // Filter functionality
        document.getElementById('roleFilter').addEventListener('change', () => this.loadUsers());
        document.getElementById('statusFilter').addEventListener('change', () => this.loadUsers());
        const deptFilter = document.getElementById('deptFilter');
        if (deptFilter) {
            deptFilter.addEventListener('change', () => this.loadUsers());
        }

        // Export
        const exportBtn = document.getElementById('exportUsersBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => this.exportUsers());
        }

        // Role change handler for employee fields
        document.querySelector('select[name="role"]').addEventListener('change', (e) => {
            const employeeFields = document.getElementById('employeeFields');
            const employeeFields2 = document.getElementById('employeeFields2');

            if (e.target.value === 'employee') {
                employeeFields.style.display = 'block';
                employeeFields2.style.display = 'block';
            } else {
                employeeFields.style.display = 'none';
                employeeFields2.style.display = 'none';
            }
        });

        // Create user form submission
        document.getElementById('createUserBtn').addEventListener('click', () => {
            this.createUser();
        });

        // Real-time validation
        this.setupRealTimeValidation();
    }

    setupRealTimeValidation() {
        const usernameInput = document.querySelector('input[name="username"]');
        const emailInput = document.querySelector('input[name="email"]');

        usernameInput.addEventListener('blur', () => this.validateUsername(usernameInput.value));
        emailInput.addEventListener('blur', () => this.validateEmail(emailInput.value));
    }

    async validateUsername(username) {
        if (!username) return;
        const isValid = !this.users.some(user => user.username === username);
        const input = document.querySelector('input[name="username"]');
        if (!isValid) {
            input.classList.add('is-invalid');
            input.nextElementSibling.textContent = 'Username already exists';
        } else {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        }
    }

    async validateEmail(email) {
        if (!email) return;
        const isValid = !this.users.some(user => user.email === email);
        const input = document.querySelector('input[name="email"]');
        if (!isValid) {
            input.classList.add('is-invalid');
            input.nextElementSibling.textContent = 'Email already exists';
        } else {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        }
    }

    getCSRFToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? match[1] : '';
    }

    async loadDepartments() {
        const deptFilter = document.getElementById('deptFilter');
        const deptSelect = document.querySelector('select[name="department_id"]');
        try {
            const res = await fetch('/api/departments/');
            if (!res.ok) return;
            const json = await res.json();
            const options = (json.departments || []).map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            if (deptFilter) deptFilter.insertAdjacentHTML('beforeend', options);
            if (deptSelect) deptSelect.insertAdjacentHTML('beforeend', options);
        } catch (e) {
            // Ignore
        }
    }

    exportUsers() {
        const params = new URLSearchParams();
        const q = document.getElementById('userSearch').value.trim();
        const role = document.getElementById('roleFilter').value;
        const status = document.getElementById('statusFilter').value;
        const dept = document.getElementById('deptFilter') ? document.getElementById('deptFilter').value : '';
        if (q) params.set('q', q);
        if (role) params.set('role', role);
        if (status) params.set('status', status);
        if (dept) params.set('department_id', dept);
        window.location.href = `/accounts/api/users/export/?${params.toString()}`;
    }


        if (!isValid) {
            input.classList.add('is-invalid');
            input.nextElementSibling.textContent = 'Email already exists';
        } else {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        }
    }

    async loadUsers() {
        this.showLoading(true);

        try {
            const params = new URLSearchParams();
            const q = document.getElementById('userSearch').value.trim();
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;
            const dept = document.getElementById('deptFilter') ? document.getElementById('deptFilter').value : '';
            if (q) params.set('q', q);
            if (role) params.set('role', role);
            if (status) params.set('status', status);
            if (dept) params.set('department_id', dept);

            const res = await fetch(`/accounts/api/users/?${params.toString()}`);
            if (!res.ok) throw new Error('Failed to load users');
            const json = await res.json();
            this.users = json.items || [];
            this.filteredUsers = this.users;
            this.renderUsers();
        } catch (error) {
            this.showAlert('Error loading users', 'danger');
        } finally {
            this.showLoading(false);
        }
    }

    filterUsers() {
        const search = document.getElementById('userSearch').value.toLowerCase();
        const roleFilter = document.getElementById('roleFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        this.filteredUsers = this.users.filter(user => {
            const matchesSearch = !search ||
                user.full_name.toLowerCase().includes(search) ||
                user.email.toLowerCase().includes(search) ||
                user.username.toLowerCase().includes(search) ||
                user.role.toLowerCase().includes(search);

            const matchesRole = !roleFilter || user.role === roleFilter;
            const matchesStatus = !statusFilter ||
                (statusFilter === 'active' && user.is_active) ||
                (statusFilter === 'inactive' && !user.is_active);

            return matchesSearch && matchesRole && matchesStatus;
        });

        this.renderUsers();
    }

    renderUsers() {
        const grid = document.getElementById('usersGrid');

        if (this.filteredUsers.length === 0) {
            grid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No users found</h5>
                    <p class="text-muted">Try adjusting your search or filters</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = this.filteredUsers.map(user => `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card user-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                    ${user.full_name.split(' ').map(n => n[0]).join('')}
                                </div>
                                <div>
                                    <h6 class="mb-1">${user.full_name}</h6>
                                    <small class="text-muted">@${user.username}</small>
                                </div>
                            </div>
                            <span class="badge role-badge ${this.getRoleBadgeClass(user.role)}">
                                ${this.getRoleDisplay(user.role)}
                            </span>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted d-block">
                                <i class="fas fa-envelope me-1"></i>
                                ${user.email}
                            </small>
                            <small class="text-muted d-block">
                                <i class="fas fa-calendar me-1"></i>
                                Joined ${new Date(user.date_joined).toLocaleDateString()}
                            </small>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                                ${user.is_active ? 'Active' : 'Inactive'}
                            </span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="userManagement.editUser(${user.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="userManagement.deleteUser(${user.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    getRoleBadgeClass(role) {
        const classes = {
            'super_admin': 'bg-danger',
            'hr_manager': 'bg-warning',
            'employee': 'bg-info'
        };
        return classes[role] || 'bg-secondary';
    }

    getRoleDisplay(role) {
        const displays = {
            'super_admin': 'Super Admin',
            'hr_manager': 'HR Manager',
            'employee': 'Employee'
        };
        return displays[role] || role;
    }

    async createUser() {
        const form = document.getElementById('createUserForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Adjust payload for employee fields
        if (data.role !== 'employee') {
            delete data.department_id;
            delete data.job_title;
            delete data.phone;
            delete data.employee_id;
        }

        // Validate form
        if (!this.validateForm(form)) {
            return;
        }

        this.setButtonLoading(true);

        try {
            const response = await fetch('/accounts/api/create-user/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                this.showAlert('User created successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                form.reset();
                this.loadUsers();
            } else {
                this.showAlert(result.error || 'Failed to create user', 'danger');
            }
        } catch (error) {
            this.showAlert('Network error. Please try again.', 'danger');
        } finally {
            this.setButtonLoading(false);
        }
    }

    validateForm(form) {
        const inputs = form.querySelectorAll('input[required], select[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                isValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });

        return isValid;
    }

    setButtonLoading(loading) {
        const btn = document.getElementById('createUserBtn');
        const btnText = btn.querySelector('.btn-text');
        const btnLoading = btn.querySelector('.btn-loading');

        if (loading) {
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            btn.disabled = true;
        } else {
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
            btn.disabled = false;
        }
    }

    showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        const grid = document.getElementById('usersGrid');

        if (show) {
            spinner.style.display = 'block';
            grid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading users...</p>
                    </div>
                </div>
            `;
        } else {
            spinner.style.display = 'none';
        }
    }

    showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alertContainer');
        const alertId = 'alert-' + Date.now();

        const alertHtml = `
            <div id="${alertId}" class="alert alert-${type} alert-floating alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        alertContainer.insertAdjacentHTML('beforeend', alertHtml);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                bootstrap.Alert.getOrCreateInstance(alert).close();
            }
        }, 5000);
    }

    async editUser(userId) {
        try {
            const res = await fetch(`/accounts/api/users/${userId}/`);
            if (!res.ok) throw new Error('Failed to load user');
            const { user } = await res.json();

            // Prefill form
            const form = document.getElementById('createUserForm');
            form.querySelector('[name="first_name"]').value = user.first_name || '';
            form.querySelector('[name="last_name"]').value = user.last_name || '';
            form.querySelector('[name="username"]').value = user.username || '';
            form.querySelector('[name="email"]').value = user.email || '';
            form.querySelector('[name="role"]').value = user.role || '';
            // Hide password field during edit
            const pwdInput = form.querySelector('[name="password"]');
            const pwdFormGroup = pwdInput.closest('.mb-3');
            pwdInput.required = false;
            pwdFormGroup.style.display = 'none';

            // Employee-specific
            const employeeFields = document.getElementById('employeeFields');
            const employeeFields2 = document.getElementById('employeeFields2');
            if (user.role === 'employee') {
                employeeFields.style.display = 'block';
                employeeFields2.style.display = 'block';
                form.querySelector('[name="employee_id"]').value = (user.employee && user.employee.employee_id) || '';
                form.querySelector('[name="job_title"]').value = (user.employee && user.employee.job_title) || '';
                const deptSelect = form.querySelector('[name="department_id"]');
                if (deptSelect && user.employee && user.employee.department) {
                    deptSelect.value = user.employee.department.id || '';
                }
                form.querySelector('[name="phone"]').value = (user.employee && user.employee.phone) || '';
            } else {
                employeeFields.style.display = 'none';
                employeeFields2.style.display = 'none';
            }

            // Update modal title and button
            const modalEl = document.getElementById('createUserModal');
            modalEl.querySelector('.modal-title').innerHTML = '<i class="fas fa-user-edit me-2 text-primary"></i>Edit User';
            const btn = document.getElementById('createUserBtn');
            btn.querySelector('.btn-text').innerHTML = '<i class="fas fa-save me-2"></i>Save Changes';

            // Override click once for update
            const onClick = async () => {
                this.setButtonLoading(true);
                try {
                    const payload = {
                        first_name: form.querySelector('[name="first_name"]').value.trim(),
                        last_name: form.querySelector('[name="last_name"]').value.trim(),
                        email: form.querySelector('[name="email"]').value.trim(),
                        role: form.querySelector('[name="role"]').value,
                    };
                    if (form.querySelector('[name="role"]').value === 'employee') {
                        const deptVal = form.querySelector('[name="department_id"]').value;
                        if (deptVal) payload.department_id = deptVal;
                        payload.job_title = form.querySelector('[name="job_title"]').value.trim();
                        payload.phone = form.querySelector('[name="phone"]').value.trim();
                    }

                    const resp = await fetch(`/accounts/api/users/${userId}/update/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify(payload)
                    });
                    const result = await resp.json();
                    if (resp.ok && result.success) {
                        this.showAlert('User updated successfully', 'success');
                        bootstrap.Modal.getInstance(modalEl).hide();
                        // Reset button handler
                        btn.removeEventListener('click', onClick);
                        // Restore modal labels
                        modalEl.querySelector('.modal-title').innerHTML = '<i class="fas fa-user-plus me-2 text-primary"></i>Create New User';
                        btn.querySelector('.btn-text').innerHTML = '<i class="fas fa-plus me-2"></i>Create User';
                        // Restore password field
                        pwdFormGroup.style.display = '';
                        pwdInput.required = true;
                        form.reset();
                        this.loadUsers();
                    } else {
                        this.showAlert(result.error || 'Failed to update user', 'danger');
                    }
                } catch (e) {
                    this.showAlert('Network error. Please try again.', 'danger');
                } finally {
                    this.setButtonLoading(false);
                }
            };

            // Ensure only one handler bound
            btn.replaceWith(btn.cloneNode(true));
            const btnNew = document.getElementById('createUserBtn');
            btnNew.addEventListener('click', onClick);

            // Show modal
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
        } catch (e) {
            this.showAlert('Failed to load user details', 'danger');
        }
    }

    async deleteUser(userId) {
        const user = this.users.find(u => u.id === userId);
        const targetActive = user ? !user.is_active : false;
        const actionText = targetActive ? 'activate' : 'deactivate';
        if (!confirm(`Are you sure you want to ${actionText} this user?`)) return;

        try {
            const resp = await fetch(`/accounts/api/users/${userId}/status/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({ is_active: targetActive })
            });
            const result = await resp.json();
            if (resp.ok && result.success) {
                this.showAlert(`User ${actionText}d successfully`, 'success');
                this.loadUsers();
            } else {
                this.showAlert(result.error || `Failed to ${actionText} user`, 'danger');
            }
        } catch (e) {
            this.showAlert('Network error. Please try again.', 'danger');
        }
    }
}

// Make userManagement globally available
let userManagement;
</script>
{% endblock %}
