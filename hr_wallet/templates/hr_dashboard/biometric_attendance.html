{% extends 'hr_dashboard/base.html' %}
{% block title %}Biometric Attendance - HR Wallet{% endblock %}
{% block page_title %}<i class="bi bi-fingerprint me-2"></i>Biometric Attendance{% endblock %}
{% block content %}
<div class="card mb-4">
  <div class="card-header d-flex flex-wrap gap-2 align-items-center">
    <span class="fw-bold"><i class="bi bi-filter me-2"></i>Filters</span>
    <form method="get" class="d-flex gap-2 flex-wrap">
      <select name="device_id" class="form-select form-select-sm w-auto">
        <option value="">All Devices</option>
        {% for device in devices %}
          <option value="{{ device.id }}" {% if filters.device_id == device.id|stringformat:'s' %}selected{% endif %}>{{ device.name }}</option>
        {% endfor %}
      </select>
      <input type="date" name="date_from" class="form-control form-control-sm w-auto" value="{{ filters.date_from }}" placeholder="From">
      <input type="date" name="date_to" class="form-control form-control-sm w-auto" value="{{ filters.date_to }}" placeholder="To">
      <select name="employee_id" class="form-select form-select-sm w-auto">
        <option value="">All Employees</option>
        {% for emp in employees %}
          <option value="{{ emp.employee_id }}" {% if filters.employee_id == emp.employee_id %}selected{% endif %}>{{ emp.user.get_full_name }} ({{ emp.employee_id }})</option>
        {% endfor %}
      </select>
      <select name="status" class="form-select form-select-sm w-auto">
        <option value="">All Types</option>
        <option value="checkin" {% if filters.status == 'checkin' %}selected{% endif %}>Check In</option>
        <option value="checkout" {% if filters.status == 'checkout' %}selected{% endif %}>Check Out</option>
        <option value="unknown" {% if filters.status == 'unknown' %}selected{% endif %}>Unknown</option>
      </select>
      <button type="submit" class="btn btn-primary btn-sm">Apply</button>
    </form>
  </div>
</div>
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span class="fw-bold"><i class="bi bi-clock-history me-2"></i>Attendance Records</span>
    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#bulkEditModal">Bulk Edit</button>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Time</th>
            <th>Device</th>
            <th>User ID</th>
            <th>Type</th>
            <th>Status</th>
            <th>Source</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for event in events %}
          <tr class="{% if event.attendance %}table-success{% else %}table-warning{% endif %}">
            <td><input type="checkbox" class="selectRow" value="{{ event.id }}"></td>
            <td>{{ event.timestamp|date:'Y-m-d H:i:s' }}</td>
            <td>
              {% if event.device %}
                {{ event.device.name }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ event.device_user_id }}</td>
            <td>{{ event.event_type|title }}</td>
            <td>{% if event.processed %}<span class="badge bg-success">Processed</span>{% else %}<span class="badge bg-warning text-dark">Pending</span>{% endif %}</td>
            <td><span class="badge {% if event.raw_payload.source == 'live' %}bg-info{% else %}bg-secondary{% endif %}">{{ event.raw_payload.source|default:'Manual' }}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal{{ event.id }}">Edit</button>
            </td>
          </tr>
          <!-- Edit Modal -->
          <div class="modal fade" id="editModal{{ event.id }}" tabindex="-1" aria-labelledby="editModalLabel{{ event.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <form method="post" action="{% url 'profile_api:biometric_attendance_edit' event.id %}">
                  {% csrf_token %}
                  <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel{{ event.id }}">Edit Attendance Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="form-label">Punch Time</label>
                      <input type="datetime-local" name="timestamp" class="form-control" value="{{ event.timestamp|date:'Y-m-d\TH:i' }}">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Type</label>
                      <select name="event_type" class="form-select">
                        <option value="checkin" {% if event.event_type == 'checkin' %}selected{% endif %}>Check In</option>
                        <option value="checkout" {% if event.event_type == 'checkout' %}selected{% endif %}>Check Out</option>
                        <option value="unknown" {% if event.event_type == 'unknown' %}selected{% endif %}>Unknown</option>
                      </select>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Bulk Edit Modal -->
<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'profile_api:biometric_attendance_bulk_edit' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="bulkEditModalLabel">Bulk Edit Attendance Records</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">New Type</label>
            <select name="event_type" class="form-select">
              <option value="">-- Select --</option>
              <option value="checkin">Check In</option>
              <option value="checkout">Check Out</option>
              <option value="unknown">Unknown</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">New Punch Time</label>
            <input type="datetime-local" name="timestamp" class="form-control">
          </div>
          <input type="hidden" name="ids" id="bulkEditIds">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Apply Bulk Edit</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
// Bulk select logic
const selectAll = document.getElementById('selectAll');
const selectRows = document.querySelectorAll('.selectRow');
if(selectAll) {
  selectAll.addEventListener('change', function() {
    selectRows.forEach(row => row.checked = selectAll.checked);
  });
}
// Collect selected IDs for bulk edit
const bulkEditModal = document.getElementById('bulkEditModal');
bulkEditModal?.addEventListener('show.bs.modal', function() {
  const selected = Array.from(document.querySelectorAll('.selectRow:checked')).map(row => row.value);
  document.getElementById('bulkEditIds').value = selected.join(',');
});
</script>
{% endblock %}
