{% extends 'hr_dashboard/base.html' %}
{% block title %}Biometric Devices - HR Wallet{% endblock %}
{% block page_title %}<i class="bi bi-fingerprint me-2"></i>Biometric Devices{% endblock %}

{% block content %}
<div class="row g-3">
  <div class="col-lg-3">
    <div class="card stats-card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold">Processed (24h)</div>
          <div id="stat-processed" class="display-6">0</div>
        </div>
        <i class="bi bi-check2-circle fs-1"></i>
      </div>
    </div>
  </div>
  <div class="col-lg-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold">Pending (24h)</div>
          <div id="stat-pending" class="display-6">0</div>
        </div>
        <i class="bi bi-hourglass-split fs-1 text-warning"></i>
      </div>
    </div>
  </div>
  <div class="col-lg-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold">Devices Online</div>
          <div id="stat-online" class="display-6">0</div>
        </div>
        <i class="bi bi-wifi fs-1 text-success"></i>
      </div>
    </div>
  </div>
  <div class="col-lg-3">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-bold">Last Refresh</div>
          <div id="last-refresh" class="display-6" style="font-size:1.6rem;">-</div>
        </div>
        <button id="btn-refresh" class="btn btn-outline-primary"><i class="bi bi-arrow-clockwise"></i></button>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4 g-3">
  <div class="col-lg-5">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-bold"><i class="bi bi-hdd-network me-2"></i>Devices</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="tbl-devices">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Last Pull</th>
              </tr>
            </thead>
            <tbody>
            {% for device in devices %}
              <tr>
                <td>{{ device.name }}</td>
                <td>
                  {% if device.is_active %}
                    <span class="badge bg-success">Connected</span>
                  {% else %}
                    <span class="badge bg-danger">Disconnected</span>
                  {% endif %}
                </td>
                <td>{{ device.last_seen|date:'Y-m-d H:i:s' }}</td>
                <td>{{ device.last_pull|date:'Y-m-d H:i:s' }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center">No devices found.</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card">
      <div class="card-header">
        <div class="d-flex flex-wrap gap-2 align-items-end">
          <span class="fw-bold"><i class="bi bi-clock-history me-2"></i>Recent Events</span>
          <select class="form-select form-select-sm w-auto" id="filter-device"></select>
          <select class="form-select form-select-sm w-auto" id="filter-type">
            <option value="">All</option>
            <option value="checkin">Check In</option>
            <option value="checkout">Check Out</option>
            <option value="unknown">Unknown</option>
          </select>
          <select class="form-select form-select-sm w-auto" id="filter-hours">
            <option value="24">Last 24h</option>
            <option value="48" selected>Last 48h</option>
            <option value="72">Last 72h</option>
          </select>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="tbl-events">
            <thead class="table-light">
              <tr>
                <th>Time</th>
                <th>Device</th>
                <th>User ID</th>
                <th>Type</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Edit Device Modal (HR) -->
<div class="modal fade" id="editDeviceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Biometric Device</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="row g-3">
          <input type="hidden" id="edit_id">
          <div class="col-12"><label class="form-label">Name</label><input type="text" class="form-control" id="edit_name" required></div>
          <div class="col-6"><label class="form-label">Brand</label><input type="text" class="form-control" id="edit_brand"></div>
          <div class="col-6"><label class="form-label">Model</label><input type="text" class="form-control" id="edit_model"></div>
          <div class="col-6"><label class="form-label">Serial Number</label><input type="text" class="form-control" id="edit_serial"></div>
          <div class="col-4"><label class="form-label">IP Address</label><input type="text" class="form-control" id="edit_ip"></div>
          <div class="col-2"><label class="form-label">Port</label><input type="number" class="form-control" id="edit_port" value="4370"></div>
          <div class="col-6"><label class="form-label">Timezone</label><input type="text" class="form-control" id="edit_tz" placeholder="UTC"></div>
          <div class="col-6"><label class="form-label">COM Key</label><input type="number" min="0" max="999999" class="form-control" id="edit_comm" placeholder="0"></div>
          <div class="col-6"><label class="form-label">API Key</label><div class="input-group"><input type="text" class="form-control" id="edit_api" readonly><button class="btn btn-outline-warning" type="button" id="btnRegenInModal"><i class="bi bi-key"></i></button></div></div>
          <div class="col-6 form-check ms-2"><input class="form-check-input" type="checkbox" id="edit_active"><label class="form-check-label" for="edit_active">Active</label></div>
          <div class="col-6 form-check ms-2"><input class="form-check-input" type="checkbox" id="edit_push"><label class="form-check-label" for="edit_push">Push Enabled</label></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="btnUpdate">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal (HR) -->
<div class="modal fade" id="deleteDeviceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Device</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to permanently delete this device? This cannot be undone.</p>
        <ul class="list-unstyled mb-0">
          <li><strong>Name:</strong> <span id="del_name"></span></li>
          <li><strong>IP Address:</strong> <span id="del_ip"></span></li>
          <li><strong>Serial:</strong> <span id="del_serial"></span></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="btnConfirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  const statusUrl = "{% url 'profile_api:biometric_status' %}";
  const devicesUrl = "{% url 'profile_api:list_biometric_devices' %}";
  const eventsUrl = "{% url 'profile_api:list_recent_biometric_events' %}";

  const $devices = document.querySelector('#tbl-devices tbody');
  const $events = document.querySelector('#tbl-events tbody');
  const $filterDevice = document.getElementById('filter-device');
  const $filterType = document.getElementById('filter-type');
  const $filterHours = document.getElementById('filter-hours');
  const $processed = document.getElementById('stat-processed');
  const $pending = document.getElementById('stat-pending');
  const $online = document.getElementById('stat-online');
  const $lastRefresh = document.getElementById('last-refresh');
  const $btnRefresh = document.getElementById('btn-refresh');

  const csrftoken = document.cookie.match(/csrftoken=([^;]+)/)?.[1];

  // Bootstrap modals (HR)
  const editModal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteDeviceModal'));

  function alertBox(msg){ alert(msg); }


  async function pingDevice(id, btn){
    try{
      btn && (btn.disabled = true);
      const r = await fetch(`/api/biometric/devices/${id}/ping/`);
      const j = await r.json();
      if(j.connected){
        alert('Device Connected Successfully');
      }else{
        alert(j.message || 'Device Not Connected');
      }
    }finally{ btn && (btn.disabled = false); }
  }

  async function syncDevice(id, btn){
    const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    try{
      const r = await fetch(`/api/biometric/devices/${id}/sync/`, {method:'POST', headers:{'X-CSRFToken': csrftoken, 'Content-Type': 'application/json'}, body: JSON.stringify({})});
      const j = await r.json();
      if(j.success){
        alert(`Sync done. Ingested: ${j.ingested||0}`);
        await loadDevices();
      }else{
        alert(j.message||'Sync failed');
      }
    }finally{ btn.disabled=false; btn.innerHTML = old; }
  }

  async function fetchJSON(url){
    const r = await fetch(url, {credentials:'same-origin'});
    if(!r.ok){ throw new Error('HTTP '+r.status); }
    return await r.json();
  }

  function fmt(dt){
    if(!dt) return '';
    try{ return new Date(dt).toLocaleString(); }catch(e){ return dt; }
  }

  function deviceOnline(d){
    if(!d.last_seen) return false;
    const diff = (Date.now() - new Date(d.last_seen).getTime())/1000; // sec
    return diff < 900; // 15 minutes
  }

  function renderDevices(devs){
    $devices.innerHTML = devs.map(d => `
      <tr>
        <td>${d.name}</td>
        <td>
          ${d.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}
          ${deviceOnline(d) ? '<span class="badge bg-info ms-1">Online</span>' : '<span class="badge bg-light text-dark ms-1">Offline</span>'}
          <button class=\"btn btn-sm btn-outline-success ms-2\" title=\"Check\" data-action=\"ping\" data-id=\"${d.id}\"><i class=\"bi bi-wifi\"></i></button>
          <button class=\"btn btn-sm btn-outline-secondary\" title=\"Sync\" data-action=\"sync\" data-id=\"${d.id}\"><i class=\"bi bi-arrow-repeat\"></i></button>
          <button class=\"btn btn-sm btn-outline-primary\" title=\"Edit\" data-action=\"edit\" data-id=\"${d.id}\"><i class=\"bi bi-pencil\"></i></button>
          <button class=\"btn btn-sm btn-outline-danger\" title=\"Delete\" data-action=\"delete\" data-id=\"${d.id}\"><i class=\"bi bi-trash\"></i></button>
        </td>
        <td>${fmt(d.last_seen)}</td>
        <td>${fmt(d.last_pull)}</td>
      </tr>`).join('');

    // Filters
    const options = ['<option value="">All devices</option>'].concat(devs.map(d => `<option value="${d.id}">${d.name}</option>`));
    $filterDevice.innerHTML = options.join('');

    // Online stat
    $online.textContent = devs.filter(deviceOnline).length;
  }

  function renderEvents(items){
    $events.innerHTML = items.map(ev => `
      <tr>
        <td>${fmt(ev.timestamp)}</td>
        <td>${ev.device || ''}</td>
        <td>${ev.device_user_id}</td>
        <td>${ev.event_type}</td>
        <td>${ev.processed ? '<span class="badge bg-success">Processed</span>' : '<span class="badge bg-warning text-dark">Pending</span>'}</td>
      </tr>`).join('');
  }
  document.getElementById('tbl-devices').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-action]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    if(action==='ping') return pingDevice(id, btn);
    if(action==='sync') return syncDevice(id, btn);
    if(action==='edit'){
      // Load details and open modal
      const data = await fetch(`/api/biometric/devices/`).then(r=>r.json()).catch(()=>({}));
      const d = (data.data||[]).find(x=>String(x.id)===String(id));
      document.getElementById('edit_id').value = id;
      document.getElementById('edit_name').value = d?.name||'';
      document.getElementById('edit_brand').value = d?.brand||'';
      document.getElementById('edit_model').value = d?.model||'';
      document.getElementById('edit_serial').value = d?.serial_number||'';
      document.getElementById('edit_ip').value = d?.ip_address||'';
      document.getElementById('edit_port').value = d?.port||4370;
      document.getElementById('edit_tz').value = d?.timezone||'UTC';
      document.getElementById('edit_active').checked = !!d?.is_active;
      document.getElementById('edit_push').checked = !!d?.push_enabled;
      document.getElementById('edit_api').value = d?.api_key || '';
      document.getElementById('edit_comm').value = '';
      editModal.show();
    }
    if(action==='delete'){
      // Populate confirmation modal
      document.getElementById('btnConfirmDelete').setAttribute('data-id', id);
      const data = await fetch('/api/biometric/devices/').then(r=>r.json()).catch(()=>({}));
      const d = (data.data||[]).find(x=>String(x.id)===String(id));
      document.getElementById('del_name').textContent = d?.name || '';
      document.getElementById('del_ip').textContent = d?.ip_address || '-';
      document.getElementById('del_serial').textContent = d?.serial_number || '-';
      deleteModal.show();
    }
  });


  // Save changes (HR)
  document.getElementById('btnUpdate').addEventListener('click', async ()=>{
    const id = document.getElementById('edit_id').value;
    const ip = document.getElementById('edit_ip').value.trim();
    const port = parseInt(document.getElementById('edit_port').value||'4370',10);
    const ipOk = ip === '' || /^(\d{1,3}\.){3}\d{1,3}$/.test(ip);
    if (!ipOk){ alertBox('Invalid IP address format'); return; }
    if (port < 1 || port > 65535){ alertBox('Port must be between 1 and 65535'); return; }

    const payload = {
      name: document.getElementById('edit_name').value.trim(),
      brand: document.getElementById('edit_brand').value.trim(),
      model: document.getElementById('edit_model').value.trim(),
      serial_number: document.getElementById('edit_serial').value.trim(),
      ip_address: ip,
      port: port,
      timezone: document.getElementById('edit_tz').value.trim()||'UTC',
      is_active: document.getElementById('edit_active').checked,
      push_enabled: document.getElementById('edit_push').checked,
    };
    const commVal = document.getElementById('edit_comm').value.trim();
    if (commVal !== '') payload.comm_key = commVal;

    const btn = document.getElementById('btnUpdate');
    const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    try{
      const r = await fetch(`/api/biometric/devices/${id}/update/`, { method:'PATCH', headers:{ 'Content-Type':'application/json','X-CSRFToken': csrftoken }, body: JSON.stringify(payload) });
      const j = await r.json().catch(()=>({success:r.ok}));
      if (r.ok){
        alertBox('Device updated.'); editModal.hide(); await refreshAll();
        // Re-check connection after update
        const pingBtn = document.querySelector(`button[data-action="ping"][data-id="${id}"]`);
        pingBtn && pingDevice(id, pingBtn);
      } else {
        if (j && j.errors){
          const msgs = Object.entries(j.errors).map(([k,v])=>`${k}: ${v}`).join('\n');
          alertBox(msgs || (j.message||'Update failed'));
        } else {
          alertBox(j.message||'Update failed');
        }
      }
    } finally {
      btn.disabled = false; btn.innerHTML = old;
    }
  });

  // Regenerate API key (HR)
  document.getElementById('btnRegenInModal').addEventListener('click', async ()=>{
    const id = document.getElementById('edit_id').value;
    if (!confirm('Regenerate API key for this device? Existing integrations will break until updated.')) return;
    const newKey = [...crypto.getRandomValues(new Uint8Array(32))].map(b=>b.toString(16).padStart(2,'0')).join('');
    const r = await fetch(`/api/biometric/devices/${id}/update/`, { method:'PATCH', headers:{ 'Content-Type':'application/json','X-CSRFToken': csrftoken }, body: JSON.stringify({ api_key: newKey }) });
    if (r.ok){ document.getElementById('edit_api').value = newKey; alertBox('API key regenerated.'); }
    else { alertBox('Failed to regenerate key'); }
  });

  // Confirm delete (HR)
  document.getElementById('btnConfirmDelete').addEventListener('click', async (e)=>{
    const id = e.currentTarget.getAttribute('data-id');
    let r = await fetch(`/api/biometric/devices/${id}/delete/`, { method:'DELETE', headers:{'X-CSRFToken': csrftoken} });
    if (r.status === 409){
      const j = await r.json().catch(()=>({message:'Device in use'}));
      if (confirm((j.message||'Device appears to be in use.') + ' Force delete?')){
        r = await fetch(`/api/biometric/devices/${id}/delete/?force=true`, { method:'DELETE', headers:{'X-CSRFToken': csrftoken} });
      } else {
        return;
      }
    }
    const j2 = await r.json().catch(()=>({success:r.ok}));
    if (r.ok && j2.success){ alertBox('Device deleted.'); deleteModal.hide(); await refreshAll(); }
    else { alertBox((j2 && (j2.message||j2.detail)) || 'Delete failed'); }
  });




  async function loadStatus(){
    const data = await fetchJSON(statusUrl);
    if(data && data.success){
      $processed.textContent = data.events.processed_24h;
      $pending.textContent = data.events.pending_24h;
    }
  }

  async function loadDevices(){
    const data = await fetchJSON(devicesUrl);
    if(data && data.success){
      renderDevices(data.data || []);
    }
  }

  async function loadEvents(){
    const params = new URLSearchParams();
    if($filterDevice.value) params.set('device_id', $filterDevice.value);
    if($filterType.value) params.set('event_type', $filterType.value);
    params.set('hours', $filterHours.value || '48');
    const data = await fetchJSON(eventsUrl + '?' + params.toString());
    if(data && data.success){ renderEvents(data.data || []); }
  }

  async function refreshAll(){
    await Promise.allSettled([loadStatus(), loadDevices(), loadEvents()]);
    $lastRefresh.textContent = new Date().toLocaleTimeString();
  }

  $btnRefresh.addEventListener('click', refreshAll);
  $filterDevice.addEventListener('change', loadEvents);
  $filterType.addEventListener('change', loadEvents);
  $filterHours.addEventListener('change', loadEvents);

  // First load + auto refresh every 30s
  refreshAll();
  setInterval(refreshAll, 30000);
})();
</script>
{% endblock %}

