{% extends 'hr_dashboard/base.html' %}

{% block title %}Employee Management - HR Dashboard{% endblock %}
{% block page_title %}Employee Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">Employee Management</h2>
                <p class="text-muted mb-0">Manage employee records and information.</p>
            </div>
            <div>
                <a href="{% url 'hr_dashboard:create_employee' %}" class="btn btn-info">
                    <i class="bi bi-person-plus me-2"></i>
                    Add New Employee
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ employees.count|default:"0" }}</h3>
                <p class="mb-0">Total Employees</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>5</h3>
                <p class="mb-0">Departments</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h3>2</h3>
                <p class="mb-0">New This Month</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>98%</h3>
                <p class="mb-0">Attendance Rate</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-people me-2"></i>
                    Employee List
                </h5>
                <div class="d-flex gap-2 align-items-center">
                    <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="Search name, ID, email..." style="width: 220px;">
                    <select id="deptFilter" class="form-select form-select-sm" style="width: 180px;">
                        <option value="">All Departments</option>
                    </select>
                    <select id="statusFilter" class="form-select form-select-sm" style="width: 140px;">
                        <option value="active" selected>Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="all">All</option>
                    </select>
                    <button id="exportBtn" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-download me-1"></i>Export CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>Employee ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Department</th>
                                <th>Position</th>
                                <th>Hire Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr data-id="{{ employee.id }}">
                                <td><input type="checkbox" class="row-check" value="{{ employee.id }}"></td>
                                <td>{{ employee.employee_id }}</td>
                                <td>{{ employee.user.get_full_name|default:employee.user.username }}</td>
                                <td>{{ employee.user.email }}</td>
                                <td>{{ employee.department.name|default:"N/A" }}</td>
                                <td>{{ employee.job_title }}</td>
                                <td>{{ employee.hire_date|date:"M d, Y" }}</td>
                                <td>
                                    {% if employee.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary view-btn" data-id="{{ employee.id }}">
                                        <i class="bi bi-eye me-1"></i>View
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning edit-btn" data-id="{{ employee.id }}">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                            More
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item view-attendance" href="#" data-id="{{ employee.id }}"><i class="bi bi-calendar me-2"></i>View Attendance</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-receipt me-2"></i>Payroll</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger deactivate-btn" href="#" data-id="{{ employee.id }}"><i class="bi bi-trash me-2"></i>{% if employee.is_active %}Deactivate{% else %}Activate{% endif %}</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>

                                <td colspan="9" class="text-center text-muted">No employees found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Employee Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeModalTitle">Create Employee</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="employeeForm">
          <input type="hidden" id="empId">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Full Name</label>
              <input id="fullName" type="text" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input id="email" type="email" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input id="phone" type="text" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Department</label>
              <select id="department" class="form-select" required>
                <option value="">Select department</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Job Title</label>
              <input id="jobTitle" type="text" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Salary</label>
              <input id="salary" type="number" step="0.01" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">Address</label>
              <textarea id="address" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </form>
        <div id="formAlert" class="alert alert-danger d-none mt-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button id="saveEmployeeBtn" type="button" class="btn btn-primary">
          <span class="spinner-border spinner-border-sm d-none" id="saveSpinner"></span>
          <span id="saveText">Save</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Employee Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="detailsBody">Loading...</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Wait for Bootstrap to be loaded
function waitForBootstrap() {
  return new Promise((resolve) => {
    if (typeof bootstrap !== 'undefined') {
      resolve();
    } else {
      setTimeout(() => {
        waitForBootstrap().then(resolve);
      }, 100);
    }
  });
}

waitForBootstrap().then(() => {
  console.log('Bootstrap loaded, initializing employee management');
  
  (function() {
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const employeeModal = new bootstrap.Modal(document.getElementById('employeeModal'));
    const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

  // CSRF helper for POST/PATCH requests
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrfToken = getCookie('csrftoken');


  async function loadDepartments() {
    try {
      const res = await fetch('/api/departments/');
      const json = await res.json();
      if (!json.success) return;
      const list = json.data || [];
      const deptFilter = $('#deptFilter');
      const deptSelect = $('#department');
      list.forEach(d => {
        const opt1 = document.createElement('option'); opt1.value = d.id; opt1.textContent = d.name; deptFilter.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = d.id; opt2.textContent = d.name; deptSelect.appendChild(opt2);
      });
    } catch(e) { /* ignore */ }
  }

  async function loadEmployees() {
    const q = encodeURIComponent($('#searchInput').value.trim());
    const dept = encodeURIComponent($('#deptFilter').value);
    const status = encodeURIComponent($('#statusFilter').value);
    const url = `/api/employees/list/?q=${q}&department_id=${dept}&status=${status}&page_size=200`;
    const tbody = document.querySelector('table tbody');
    tbody.innerHTML = '<tr><td colspan="9" class="text-center">Loading...</td></tr>';
    try {
      const res = await fetch(url);
      const json = await res.json();
      if (!json.success) throw new Error('Failed');
      const rows = (json.data || []).map(e => `
        <tr data-id="${e.id}">
          <td><input type="checkbox" class="row-check" value="${e.id}"></td>
          <td>${e.employee_id || ''}</td>
          <td>${e.full_name || ''}</td>
          <td>${e.email || ''}</td>
          <td>${e.department_name || 'N/A'}</td>
          <td>${e.job_title || ''}</td>
          <td>${e.hire_date || ''}</td>
          <td>${e.is_active ? '<span class=\"badge bg-success\">Active</span>' : '<span class=\"badge bg-danger\">Inactive</span>'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary view-btn" data-id="${e.id}"><i class="bi bi-eye me-1"></i>View</button>
            <button class="btn btn-sm btn-outline-warning edit-btn" data-id="${e.id}"><i class="bi bi-pencil me-1"></i>Edit</button>
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">More</button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item view-attendance" href="#" data-id="${e.id}"><i class="bi bi-calendar me-2"></i>View Attendance</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger deactivate-btn" href="#" data-id="${e.id}"><i class="bi bi-trash me-2"></i>${e.is_active ? 'Deactivate' : 'Activate'}</a></li>
              </ul>
            </div>
          </td>
        </tr>`).join('');
      tbody.innerHTML = rows || '<tr><td colspan="9" class="text-center text-muted">No employees found</td></tr>';
    } catch(e) {
      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Failed to load employees</td></tr>';
    }
  }

  document.getElementById('exportBtn').addEventListener('click', () => {
    const q = encodeURIComponent(document.getElementById('searchInput').value.trim());
    const dept = encodeURIComponent(document.getElementById('deptFilter').value);
    const status = encodeURIComponent(document.getElementById('statusFilter').value);
    window.location = `/api/employees/export/?q=${q}&department_id=${dept}&status=${status}`;
  });

  document.getElementById('selectAll').addEventListener('change', (e) => {
    document.querySelectorAll('.row-check').forEach(cb => cb.checked = e.target.checked);
  });

  // Event delegation for dynamically loaded content
  document.addEventListener('click', async (e) => {
    const viewBtn = e.target.closest('.view-btn');
    const editBtn = e.target.closest('.edit-btn');
    const deactBtn = e.target.closest('.deactivate-btn');
    const attendanceBtn = e.target.closest('.view-attendance');

    if (viewBtn) { 
      e.preventDefault(); 
      await showDetails(viewBtn.dataset.id); 
    }
    if (editBtn) { 
      e.preventDefault(); 
      await openEdit(editBtn.dataset.id); 
    }
    if (deactBtn) { 
      e.preventDefault(); 
      await toggleStatus(deactBtn.dataset.id); 
    }
    if (attendanceBtn) {
      e.preventDefault();
      window.location.href = `/hr-dashboard/attendance/?employee_id=${attendanceBtn.dataset.id}`;
    }
  });

  async function showDetails(id) {
    document.getElementById('detailsBody').innerHTML = 'Loading...'; 
    detailsModal.show();
    try {
      const res = await fetch(`/api/employees/${id}/`);
      if (!res.ok) throw new Error('Failed to fetch employee details');
      const json = await res.json();
      if (!json.success) throw new Error(json.message || 'Failed to load employee details');
      
      const emp = json.data.employee; 
      const lb = json.data.leave_balance; 
      const att = json.data.recent_attendance || [];
      
      document.getElementById('detailsBody').innerHTML = `
        <div class="row g-3">
          <div class="col-md-6"><strong>${emp.full_name || emp.first_name + ' ' + emp.last_name}</strong><div class="text-muted">${emp.email}</div></div>
          <div class="col-md-6 text-end">ID: ${emp.employee_id}</div>
          <div class="col-md-4"><div>Department</div><div class="fw-semibold">${emp.department_name || 'N/A'}</div></div>
          <div class="col-md-4"><div>Job Title</div><div class="fw-semibold">${emp.job_title || ''}</div></div>
          <div class="col-md-4"><div>Phone</div><div class="fw-semibold">${emp.phone || ''}</div></div>
          <div class="col-12"><div>Address</div><div class="fw-semibold">${emp.address || ''}</div></div>
          <div class="col-12 mt-3"><h6>Leave Balance</h6>
            ${lb ? `<div class="d-flex gap-4">
              <div>Annual: ${lb.annual_used}/${lb.annual_total} (Rem ${lb.annual_remaining})</div>
              <div>Sick: ${lb.sick_used}/${lb.sick_total} (Rem ${lb.sick_remaining})</div>
              <div>Personal: ${lb.personal_used}/${lb.personal_total} (Rem ${lb.personal_remaining})</div>
            </div>` : '<div class="text-muted">No leave balance</div>'}
          </div>
          <div class="col-12 mt-3"><h6>Recent Attendance</h6>
            ${att.length ? `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Date</th><th>Status</th><th>Hours</th></tr></thead><tbody>${att.map(a => `<tr><td>${a.date}</td><td>${a.status}</td><td>${a.total_hours ?? ''}</td></tr>`).join('')}</tbody></table></div>` : '<div class="text-muted">No records</div>'}
          </div>
        </div>`;
    } catch(e) { 
      document.getElementById('detailsBody').innerHTML = '<div class="text-danger">Failed to load details: ' + e.message + '</div>'; 
    }
  }

  async function openCreate() {
    document.getElementById('employeeModalTitle').textContent = 'Create Employee'; 
    document.getElementById('empId').value = '';
    document.getElementById('fullName').value = ''; 
    document.getElementById('email').value = ''; 
    document.getElementById('phone').value = '';
    document.getElementById('department').value = ''; 
    document.getElementById('jobTitle').value = ''; 
    document.getElementById('salary').value = ''; 
    document.getElementById('address').value = '';
    document.getElementById('formAlert').classList.add('d-none'); 
    employeeModal.show();
  }
  async function openEdit(id) {
    document.getElementById('employeeModalTitle').textContent = 'Edit Employee'; 
    document.getElementById('empId').value = id; 
    document.getElementById('formAlert').classList.add('d-none');
    try {
      const res = await fetch(`/api/employees/${id}/`); 
      if (!res.ok) throw new Error('Failed to fetch employee data');
      const json = await res.json(); 
      if (!json.success) throw new Error(json.message || 'Failed to load employee');
      
      const emp = json.data.employee;
      document.getElementById('fullName').value = `${emp.first_name || ''} ${emp.last_name || ''}`.trim();
      document.getElementById('email').value = emp.email || ''; 
      document.getElementById('phone').value = emp.phone || '';
      document.getElementById('department').value = emp.department_id || ''; 
      document.getElementById('jobTitle').value = emp.job_title || '';
      document.getElementById('salary').value = emp.salary || ''; 
      document.getElementById('address').value = emp.address || '';
      employeeModal.show();
    } catch(e) { 
      alert('Failed to load employee: ' + e.message); 
    }
  }

  async function toggleStatus(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) {
      alert('Employee not found');
      return;
    }
    
    const isActive = row.querySelector('.badge.bg-success');
    const action = isActive ? 'deactivate' : 'activate';
    
    if (!confirm(`Are you sure you want to ${action} this employee?`)) return;
    
    try {
      const body = new URLSearchParams({ is_active: isActive ? 'false' : 'true' });
      const res = await fetch(`/api/employees/${id}/status/`, { 
        method: 'PATCH', 
        headers: { 
          'Content-Type': 'application/x-www-form-urlencoded', 
          'X-CSRFToken': csrfToken 
        }, 
        body 
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const json = await res.json(); 
      if (!json.success) {
        throw new Error(json.message || 'Failed to update status');
      }
      
      // Reload the employee list to reflect changes
      await loadEmployees();
      
      // Show success message
      const message = `Employee ${action}d successfully`;
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '9999';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 3000);
      
    } catch(e) { 
      alert('Failed to update status: ' + e.message); 
    }
  }

  document.getElementById('saveEmployeeBtn').addEventListener('click', async () => {
    const id = document.getElementById('empId').value; 
    const fullName = document.getElementById('fullName').value.trim(); 
    const email = document.getElementById('email').value.trim();
    const payloadCreate = { 
      full_name: fullName, 
      email, 
      phone: document.getElementById('phone').value.trim(), 
      department_id: document.getElementById('department').value, 
      designation: document.getElementById('jobTitle').value.trim(), 
      salary: document.getElementById('salary').value ? parseFloat(document.getElementById('salary').value) : null 
    };
    const [first, ...rest] = fullName.split(' ');
    const payloadUpdate = { 
      first_name: first || '', 
      last_name: rest.join(' '), 
      email, 
      phone: document.getElementById('phone').value.trim(), 
      department_id: document.getElementById('department').value || null, 
      job_title: document.getElementById('jobTitle').value.trim(), 
      salary: document.getElementById('salary').value ? parseFloat(document.getElementById('salary').value) : null, 
      address: document.getElementById('address').value.trim() 
    };
    const btn = document.getElementById('saveEmployeeBtn'); 
    const sp = document.getElementById('saveSpinner'); 
    const txt = document.getElementById('saveText'); 
    sp.classList.remove('d-none'); 
    txt.textContent = 'Saving...'; 
    btn.disabled = true; 
    document.getElementById('formAlert').classList.add('d-none');
    try {
      let res, json; 
      if (id) { 
        res = await fetch(`/api/employees/${id}/update/`, { 
          method: 'PATCH', 
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, 
          body: JSON.stringify(payloadUpdate) 
        }); 
      } else { 
        res = await fetch('/api/employees/', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, 
          body: JSON.stringify(payloadCreate) 
        }); 
      }
      json = await res.json(); 
      if (!res.ok || json.success === false) throw new Error(json.message || 'Failed to save'); 
      employeeModal.hide(); 
      await loadEmployees();
    } catch(e) { 
      const alert = document.getElementById('formAlert'); 
      alert.textContent = e.message || 'Failed to save'; 
      alert.classList.remove('d-none'); 
    }
    finally { 
      sp.classList.add('d-none'); 
      txt.textContent = 'Save'; 
      btn.disabled = false; 
    }
  });

  // Enable create button to open modal instead of navigating
  const addBtn = document.querySelector('a[href$="create_employee"]'); 
  if (addBtn) { 
    addBtn.addEventListener('click', (e) => { 
      e.preventDefault(); 
      openCreate(); 
    }); 
  }

  // Search and filter event listeners
  document.getElementById('searchInput').addEventListener('input', () => { loadEmployees(); });
  document.getElementById('deptFilter').addEventListener('change', () => { loadEmployees(); });
  document.getElementById('statusFilter').addEventListener('change', () => { loadEmployees(); });

  loadDepartments();
  // Load employees dynamically on page load
  loadEmployees();
})();

}); // End waitForBootstrap
</script>

{% endblock %}
